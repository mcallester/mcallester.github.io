\input ../SlidePreamble
\input ../preamble


\begin{document}

{\Huge

  \centerline{\bf TTIC 31230, Fundamentals of Deep Learning}
  \bigskip
  \centerline{David McAllester, Autumn 2022}
  \vfill
  \vfil
  \centerline{Markovian VAEs}
  \vfill
  \vfill

\slide{Markovian VAEs}

A diffusion models computes and inverts a sequence

\vfill
\centerline{\includegraphics[width = 7in]{\images/DiffSequence}}

\vfill
So does an autoregressive language model

\vfill
{\huge
\centerline{{\color{red} [Sally talked to John]} $\stackrel{\rightarrow}{\leftarrow}$ {\color{red} [Sally talked to]}
$\stackrel{\rightarrow}{\leftarrow}$ {\color{red}[Sally talked]} $\stackrel{\rightarrow}{\leftarrow}$ {\color{red}[Sally]}}
}


\slide{Markovian VAEs}


\centerline{\includegraphics[width = 7in]{\images/DiffSequence}}

\vfill
{\huge
\centerline{{\color{red} [Sally talked to John]} $\stackrel{\rightarrow}{\leftarrow}$ {\color{red} [Sally talked to]}
$\stackrel{\rightarrow}{\leftarrow}$ {\color{red}[Sally talked]} $\stackrel{\rightarrow}{\leftarrow}$ {\color{red}[Sally]}}
}

\vfill
\centerline{$z_0 \stackrel{\rightarrow}{\leftarrow} z_1  \stackrel{\rightarrow}{\leftarrow} \cdots \stackrel{\rightarrow}{\leftarrow} z_L$}

\slide{Markovian VAEs}
\centerline{$z_0 \stackrel{\rightarrow}{\leftarrow} z_1  \stackrel{\rightarrow}{\leftarrow} \cdots \stackrel{\rightarrow}{\leftarrow} z_L$}

\vfill
{\bf Encoder}: $\pop(z_0)$ and $P_\enc(z_{\ell+1}|z_\ell)$.


\vfill
{\bf Generator}: $P_\pri(z_L)$ $P_\gen(z_{\ell-1}|z_\ell)$.

\vfill
The encoder and the decoder define distributions $P_\enc(z_0,\ldots,z_L)$ and $P_\gen(z_0,\ldots,z_N)$ respectively.

\slide{VAE Review}

A variational autoencoder (VAE) has only $z_0$ (previously written $y$) and $z_1$ (previously written $z$).

\begin{eqnarray*}
P_\enc(z_0,z_1) & = & \pop(z_0)P_\enc(z_1|z_0) \\
\\
P_\gen(z_0,z_1) & = & P_\pri(z_1)P_\gen(z_0|z_1)
\end{eqnarray*}


\slide{The Single Layer ELBO}

{\huge

\begin{eqnarray*}
 H(z_0) & = & E_\enc\left[ -\ln \frac{P_\enc(z_0)P_\enc(z_1|z_0)}{P_\enc(z_1|z_0)}\right] \\
  \\
  \\
  & = & E_\enc\left[-\ln \frac{P_{\color{red} \enc}(z_1)P_{\color{red} \enc}(z_0|z_1)}{P_\enc(z_1|z_0)}\right] \\
  \\
  \\
  & {\color{red} \leq} & E_\enc\left[ -\ln \frac{P_{\color{red} \gen}(z_1)P_{\color{red} \gen}(z_0|z_1)}{P_\enc(z_1|z_0)}\right] \;\;\mbox{cross-entropy bounds entropy} \\
  \\
  \\
  & = & E_\enc\;\;KL(P_\enc(z_1|z_0),\;P_{\gen}(z_1)) + E_\enc[-\ln P_{ \gen}(z_0|z_1)]
\end{eqnarray*}
}

\slide{The Markovian ELBO}

{\Large
\begin{eqnarray*}
H(z_0) & = & E_\enc\left[- \ln\frac{P_\enc(z_0)P_\enc(z_1,\ldots,z_L|z_0)}{P_\enc(z_1,\ldots,z_L|z_0)}\right]\\
  \\
  \\
  & = & E_\enc\left[ - \ln\frac{P_{\color{red} \enc}(z_0|z_1)P_{\color{red} \enc}(z_1|z_2)\cdots P_{\color{red} \enc}(z_{L-1}|z_L)P_{\color{red} \enc}(z_L)}
  {P_\enc(z_1|z_2,z_0)\cdots P_\enc(z_{L-1}|z_L,z_0)P_\enc(z_L|z_0)}\right] \\
   \\
   \\
  & {\color{red} \leq} & E_\enc\left[ - \ln\frac{P_{\color{red} \gen}(z_0|z_1)P_{\color{red} \gen}(z_1|z_2)\cdots P_{\color{red} \gen}(z_{L-1}|z_L)P_{\color{red} \gen}(z_L)}
  {P_\enc(z_1|z_2,z_0)\cdots P_\enc(z_{L-1}|z_L,z_0)P_\enc(z_L|z_0)}\right] \\
\\
\\
 & = & \left\{\begin{array}{l}E_\enc\;[-\ln P_\gen(z_0|z_1)]
                             \\ \\ + \sum_{i=2}^L  \; E_\enc\; KL(P_\enc(z_{i-1}|z_i,z_0),\;P_\gen(z_{i-1}|z_i)) \\
                             \\ + E_\enc\; KL(P_\enc(Z_L|z_0),p_\gen(Z_L))\end{array}\right.
\end{eqnarray*}
}

\slide{END}

\end{document}
